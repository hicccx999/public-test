name: æ•°æ®48æ‰¹æ¬¡ä¸‹è½½
permissions:
  contents: write

on:
  # schedule:
  #   # æ¯å°æ—¶æ•´ç‚¹æ‰§è¡Œï¼ˆUTCï¼‰ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´æ¯å°æ—¶
  #   - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      batch_index:
        description: 'æ‰‹åŠ¨æŒ‡å®šæ‰¹æ¬¡å· (0-47)ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨è®¡ç®—'
        required: false
        type: string
      from_date:
        description: 'èµ·å§‹æ—¥æœŸ (YYYYMMDD)ï¼Œé»˜è®¤ 20260101'
        required: false
        type: string
        default: '20260101'

env:
  TZ: Asia/Shanghai
  # èµ·å§‹æ—¶é—´ï¼šç¬¬ 0 æ‰¹ä»æ­¤æ—¶åˆ»å¼€å§‹ï¼Œæ¯å°æ—¶æ¨è¿›ä¸€æ‰¹
  START_TIME: '2026-02-21 15:00:00'
  TOTAL_BATCHES: '48'

jobs:
  batch-download:
    runs-on: ubuntu-latest
    timeout-minutes: 80

    steps:
      - name: è®¡ç®—æ‰¹æ¬¡å·å¹¶åˆ¤æ–­æ˜¯å¦æ‰§è¡Œ
        id: calc
        run: |
          export TZ='Asia/Shanghai'
          NOW=$(date '+%Y-%m-%d %H:%M:%S')
          echo "â° å½“å‰åŒ—äº¬æ—¶é—´: $NOW"

          START="${START_TIME}"
          echo "ğŸ• èµ·å§‹æ—¶é—´: $START"

          # è®¡ç®—å°æ—¶å·®
          NOW_EPOCH=$(date -d "$NOW" +%s 2>/dev/null || date -j -f "%Y-%m-%d %H:%M:%S" "$NOW" +%s)
          START_EPOCH=$(date -d "$START" +%s 2>/dev/null || date -j -f "%Y-%m-%d %H:%M:%S" "$START" +%s)
          DIFF_HOURS=$(( (NOW_EPOCH - START_EPOCH) / 3600 ))
          echo "ğŸ“Š å°æ—¶å·®: $DIFF_HOURS"

          # æ‰‹åŠ¨æŒ‡å®šæˆ–è‡ªåŠ¨è®¡ç®—
          if [ -n "${{ github.event.inputs.batch_index }}" ]; then
            BATCH_INDEX="${{ github.event.inputs.batch_index }}"
            echo "ğŸ”§ æ‰‹åŠ¨æŒ‡å®šæ‰¹æ¬¡: $BATCH_INDEX"
          else
            BATCH_INDEX=$DIFF_HOURS
          fi

          echo "batch_index=$BATCH_INDEX" >> "$GITHUB_OUTPUT"

          if [ "$BATCH_INDEX" -lt 0 ] || [ "$BATCH_INDEX" -ge "$TOTAL_BATCHES" ]; then
            echo "â­ï¸  æ‰¹æ¬¡å· $BATCH_INDEX ä¸åœ¨ 0~$((TOTAL_BATCHES - 1)) èŒƒå›´å†…ï¼Œè·³è¿‡"
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… å°†æ‰§è¡Œæ‰¹æ¬¡: $BATCH_INDEX"
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          fi

      - name: æ£€å‡º stock-grabber ä»£ç 
        if: steps.calc.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: è®¾ç½® Python ç¯å¢ƒ
        if: steps.calc.outputs.should_run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: æ‰“å°ä»»åŠ¡ä¿¡æ¯
        if: steps.calc.outputs.should_run == 'true'
        run: |
          echo "UTC: $(date -u)"
          echo "Beijing: $(TZ='Asia/Shanghai' date)"
          echo "ğŸ“¦ æ‰¹æ¬¡å·: ${{ steps.calc.outputs.batch_index }} / $((TOTAL_BATCHES - 1))"
          echo "ğŸ“… èµ·å§‹æ—¶é—´: $START_TIME"

          TOTAL=$(python3 -c "
          import json; d=json.load(open('data/all_stocks.json'))
          print(d['count']['total'])
          ")
          echo "ğŸ“ˆ æ€»æ•°: $TOTAL"

          BATCH_SIZE=$(python3 -c "
          import json, math
          d=json.load(open('data/all_stocks.json'))
          print(math.ceil(d['count']['total'] / $TOTAL_BATCHES))
          ")
          echo "ğŸ“Š æ¯æ‰¹çº¦: $BATCH_SIZE åª"

      - name: ä¸‹è½½æ•°æ®
        if: steps.calc.outputs.should_run == 'true'
        env:
          REPO_OWNER: ${{ secrets.TARGET_REPO_OWNER }}
          REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
          FROM_DATE: ${{ github.event.inputs.from_date || '20260101' }}
        run: |
          python3 scripts3/batch-pankou-download.py \
            batch_index=${{ steps.calc.outputs.batch_index }} \
            from_date=$FROM_DATE \
            total_batches=$TOTAL_BATCHES
