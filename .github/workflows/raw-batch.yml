name: æ‰¹é‡ä¸‹è½½åˆ°github
permissions:
  contents: write

on:
  # schedule:
  #   - cron: '0 14 * * *'
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  # â”€â”€ 1. ç”ŸæˆçŸ©é˜µ â”€â”€
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.gen.outputs.matrix }}
      should_run: ${{ steps.gen.outputs.should_run }}
      from_date: ${{ steps.gen.outputs.from_date }}
      to_date: ${{ steps.gen.outputs.to_date }}
      batch_secids: ${{ steps.gen.outputs.batch_secids }}
    steps:
      - name: æ£€å‡º stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: ç”Ÿæˆåˆ†ç‰‡çŸ©é˜µ
        id: gen
        run: python3 scripts2/prepare-raw-batch.py

  # â”€â”€ 2. æ¯åªè‚¡ç¥¨ 1 ä¸ª jobï¼Œå¹¶è¡Œä¸‹è½½å…¨å¹´æ•°æ®å¹¶æ¨é€ â”€â”€
  download:
    needs: prepare
    if: needs.prepare.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 50
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: æ£€å‡º stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: ä¸‹è½½ ${{ matrix.secid }} å…¨å¹´æ•°æ®å¹¶æ¨é€
        env:
          REPO_OWNER: ${{ secrets.TARGET_REPO_OWNER }}
          REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
        run: |
          chmod +x scripts2/workflow-raw.sh
          scripts2/workflow-raw.sh "${{ matrix.secid }}" "${{ needs.prepare.outputs.from_date }}" "${{ needs.prepare.outputs.to_date }}"

      - name: è®°å½•æˆåŠŸ
        if: success()
        run: echo "${{ matrix.secid }}" > success.txt

      - name: ä¸Šä¼ æˆåŠŸæ ‡è®°
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: success-${{ matrix.secid }}
          path: success.txt

  # â”€â”€ 3. æ±‡æ€»æˆåŠŸçš„è‚¡ç¥¨ï¼Œæ›´æ–° temp2_stocks.json â”€â”€
  update:
    needs: [prepare, download]
    if: needs.prepare.outputs.should_run == 'true' && !cancelled()
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡º stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: ä¸‹è½½æ‰€æœ‰æˆåŠŸæ ‡è®°
        uses: actions/download-artifact@v4
        with:
          pattern: success-*
          path: results/

      - name: æ›´æ–° temp2_stocks.json
        run: |
          python3 -c "
          import json, glob, os

          # æ”¶é›†æœ¬æ¬¡æˆåŠŸçš„è‚¡ç¥¨
          succeeded = set()
          for f in glob.glob('results/success-*/success.txt'):
              with open(f) as fh:
                  secid = fh.read().strip()
                  if secid:
                      succeeded.add(secid)
          print(f'âœ… æœ¬æ¬¡æˆåŠŸ: {len(succeeded)} åª')

          # è¯»å–ç°æœ‰ temp2
          temp2_path = 'data/temp2_stocks.json'
          with open(temp2_path) as f:
              temp2 = json.load(f)

          completed = set(temp2.get('completed', []))
          completed.update(succeeded)
          temp2['completed'] = sorted(completed)

          with open(temp2_path, 'w') as f:
              json.dump(temp2, f, ensure_ascii=False, indent=2)

          print(f'ğŸ“Š ç´¯è®¡å®Œæˆ: {len(completed)} åª')
          remaining = 5484 - len(completed)
          if remaining > 0:
              runs_needed = (remaining + 49) // 50
              print(f'ğŸ“ å‰©ä½™: {remaining} åªï¼Œé¢„è®¡è¿˜éœ€ {runs_needed} æ¬¡è¿è¡Œ')
          else:
              print('ğŸ‰ æ‰€æœ‰è‚¡ç¥¨å·²å¤„ç†å®Œæˆï¼')
          "

      - name: æäº¤æ›´æ–°
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/temp2_stocks.json
          git diff --cached --quiet && echo "æ— å˜æ›´" || (git commit -m "chore: update temp2_stocks.json" && git push)
