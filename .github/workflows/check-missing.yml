name: 检查缺失交易日
permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'today=下载当天全市场, errors=重试失败, all=全量检查, missing=补缺失'
        required: false
        default: 'today'
        type: choice
        options:
          - today
          - errors
          - all
          - missing
      period:
        description: '检查周期: YYYY 或 YYYYMM (all/errors 模式有效，默认 2025)'
        required: false
        type: string

env:
  TZ: Asia/Shanghai

jobs:
  # ── today 模式：下载当天全市场数据 ──
  today-prepare:
    if: inputs.mode == 'today' || inputs.mode == ''
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.matrix.outputs.should_run }}
      today: ${{ steps.matrix.outputs.today }}
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: 检出 stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: 生成 today 分片矩阵
        id: matrix
        run: python3 scripts2/prepare-today-matrix.py

  today-shard:
    if: (inputs.mode == 'today' || inputs.mode == '') && needs.today-prepare.outputs.should_run == 'true'
    needs: today-prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix: ${{ fromJson(needs.today-prepare.outputs.matrix) }}
    steps:
      - name: 检出 stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: 下载当天数据 (分片 ${{ matrix.shard }})
        env:
          REPO_OWNER: ${{ secrets.TARGET_REPO_OWNER }}
          REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
          SECIDS: ${{ matrix.secids }}
          SHARD_ID: ${{ matrix.shard }}
          FIX_MODE: today
          TODAY_DATE: ${{ needs.today-prepare.outputs.today }}
        run: python3 scripts2/fix-missing-dates.py

  # ── check 模式：检查缺失日期 ──
  check:
    if: inputs.mode == 'errors' || inputs.mode == 'all'
    runs-on: ubuntu-latest
    steps:
      - name: 检出 stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: 检查缺失日期
        env:
          REPO_OWNER: ${{ secrets.TARGET_REPO_OWNER }}
          REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
          CHECK_MODE: ${{ inputs.mode }}
          CHECK_PERIOD: ${{ inputs.period }}
        run: python3 scripts2/check-missing-dates.py

      - name: 提交结果
        env:
          GRABBER_PAT: ${{ secrets.GRABBER_PAT }}
        run: |
          git remote set-url origin "https://x-access-token:${GRABBER_PAT}@github.com/hiyishui/stock-grabber.git"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/missing_dates.json
          git diff --cached --quiet && echo "无变更" || (git commit -m "chore: update missing_dates.json" && git push)

  # ── missing 模式：补下载缺失日期 ──
  fix:
    if: inputs.mode == 'missing'
    runs-on: ubuntu-latest
    outputs:
      has_missing: ${{ steps.matrix.outputs.has_missing }}
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: 检出 stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: 生成分片矩阵
        id: matrix
        run: python3 scripts2/prepare-fix-matrix.py

  fix-shard:
    if: inputs.mode == 'missing' && needs.fix.outputs.has_missing == 'true'
    needs: fix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix: ${{ fromJson(needs.fix.outputs.matrix) }}
    steps:
      - name: 检出 stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: 补下载缺失日期数据 (分片 ${{ matrix.shard }})
        env:
          REPO_OWNER: ${{ secrets.TARGET_REPO_OWNER }}
          REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
          SECIDS: ${{ matrix.secids }}
          SHARD_ID: ${{ matrix.shard }}
        run: python3 scripts2/fix-missing-dates.py

      - name: 上传分片结果
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fix-result-${{ matrix.shard }}
          path: data/fix_results/shard_${{ matrix.shard }}.json
          retention-days: 1

  fix-merge:
    if: inputs.mode == 'missing' && needs.fix.outputs.has_missing == 'true'
    needs: [fix, fix-shard]
    runs-on: ubuntu-latest
    steps:
      - name: 检出 stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: 下载所有分片结果
        uses: actions/download-artifact@v4
        with:
          pattern: fix-result-*
          path: data/fix_results
          merge-multiple: true

      - name: 汇总修复结果
        run: python3 scripts2/merge-fix-results.py

      - name: 提交结果
        env:
          GRABBER_PAT: ${{ secrets.GRABBER_PAT }}
        run: |
          git remote set-url origin "https://x-access-token:${GRABBER_PAT}@github.com/hiyishui/stock-grabber.git"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/missing_dates.json
          git diff --cached --quiet && echo "无变更" || (git commit -m "chore: fix missing dates" && git push)
