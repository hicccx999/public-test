name: å†å²ç›˜å£æ•°æ®æ‰¹é‡ä¸‹è½½
permissions:
  contents: write

on:
  schedule:
    # æ¯å¤© UTC 14:00ï¼ˆåŒ—äº¬æ—¶é—´ 22:00ï¼‰æ‰§è¡Œ
    - cron: '0 14 * * *'
  workflow_dispatch:
    inputs:
      day_number:
        description: 'ç¬¬å‡ å¤©ï¼ˆç•™ç©ºåˆ™è‡ªåŠ¨è®¡ç®—ï¼Œ1 = 2026-02-21ï¼‰'
        required: false
        type: string
      batch_size:
        description: 'æ¯ä¸ª job å¤„ç†çš„è‚¡ç¥¨æ•°é‡ï¼ˆé»˜è®¤ 30ï¼‰'
        required: false
        type: string
        default: '30'

env:
  TZ: Asia/Shanghai

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.gen.outputs.matrix }}
      from_date: ${{ steps.gen.outputs.from_date }}
      to_date: ${{ steps.gen.outputs.to_date }}
      should_run: ${{ steps.gen.outputs.should_run }}
    steps:
      - name: æ£€å‡º stock-grabber ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.MY_PAT }}

      - name: ç”Ÿæˆåˆ†ç‰‡çŸ©é˜µ
        id: gen
        run: |
          ARGS=""
          if [ -n "${{ github.event.inputs.day_number }}" ]; then
            ARGS="$ARGS day_number=${{ github.event.inputs.day_number }}"
          fi
          if [ -n "${{ github.event.inputs.batch_size }}" ]; then
            ARGS="$ARGS batch_size=${{ github.event.inputs.batch_size }}"
          fi
          python3 scripts2/prepare-matrix-all.py $ARGS

  download:
    needs: prepare
    if: needs.prepare.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: æ‰“å°ä»»åŠ¡ä¿¡æ¯
        run: |
          echo "UTC: $(date -u)"
          echo "Beijing: $(TZ='Asia/Shanghai' date)"
          echo "ğŸ“¦ Batch ID: ${{ matrix.batch_id }}"
          echo "ğŸ“… æ—¥æœŸèŒƒå›´: ${{ needs.prepare.outputs.from_date }} ~ ${{ needs.prepare.outputs.to_date }}"

      - name: æ£€å‡º stock-grabber ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.MY_PAT }}

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ä¸‹è½½ç›˜å£æ•°æ®å¹¶æäº¤åˆ°ç›®æ ‡ä»“åº“
        env:
          REPO_OWNER: ${{ secrets.TARGET_REPO_OWNER }}
          REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
          FROM_DATE: ${{ needs.prepare.outputs.from_date }}
          TO_DATE: ${{ needs.prepare.outputs.to_date }}
          SECIDS: ${{ matrix.secids }}
        run: |
          chmod +x scripts2/workflow-raw.sh
          
          IFS=',' read -ra STOCK_LIST <<< "$SECIDS"
          TOTAL=${#STOCK_LIST[@]}
          echo "ğŸ“ˆ æœ¬æ‰¹æ¬¡å…± $TOTAL åªè‚¡ç¥¨"
          
          SUCCESS=0
          FAIL=0
          
          for i in "${!STOCK_LIST[@]}"; do
            SECID="${STOCK_LIST[$i]}"
            NUM=$((i + 1))
            echo ""
            echo "============================================"
            echo "[$NUM/$TOTAL] å¤„ç†è‚¡ç¥¨: $SECID"
            echo "============================================"
            
            if scripts2/workflow-raw.sh "$SECID" "$FROM_DATE" "$TO_DATE"; then
              SUCCESS=$((SUCCESS + 1))
            else
              FAIL=$((FAIL + 1))
              echo "âš ï¸ $SECID å¤„ç†å¤±è´¥ï¼Œç»§ç»­ä¸‹ä¸€åª..."
            fi
          done
          
          echo ""
          echo "ğŸ“Š æ‰¹æ¬¡å®Œæˆ: æˆåŠŸ $SUCCESS, å¤±è´¥ $FAIL, æ€»è®¡ $TOTAL"
