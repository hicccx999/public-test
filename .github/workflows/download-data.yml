name: 下载盘口数据
permissions:
  contents: write

on:
#   schedule:
#     - cron: '0 8 * * 1-5'  # UTC 08:00 = 北京 16:00, 工作日收盘后
  workflow_dispatch:
    inputs:
      date:
        description: '日期: YYYY/YYYYMM/YYYYMMDD, 多个逗号分隔, 留空=当天'
        required: false
        type: string
      codes:
        description: '股票代码(纯数字), 逗号分隔, 留空=全部'
        required: false
        type: string
      force:
        description: '强制重下载已完成的日期'
        required: false
        default: false
        type: boolean

env:
  TZ: Asia/Shanghai

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.matrix.outputs.should_run }}
      date: ${{ steps.matrix.outputs.date }}
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: 检出 stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: 生成分片矩阵
        id: matrix
        env:
          MODE: download
          DATE: ${{ inputs.date }}
          ONLY_CODES: ${{ inputs.codes }}
          FORCE: ${{ inputs.force }}
        run: python3 scripts/prepare_matrix.py

  download:
    if: needs.prepare.outputs.should_run == 'true'
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 40
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: 检出 stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: 下载数据 (分片 ${{ matrix.shard }}, ${{ matrix.count }} 只)
        env:
          REPO_OWNER: ${{ secrets.TARGET_REPO_OWNER }}
          REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
          SECIDS: ${{ matrix.secids }}
          SHARD_ID: ${{ matrix.shard }}
          DATE: ${{ needs.prepare.outputs.date }}
          FORCE: ${{ inputs.force }}
        run: python3 scripts/download_data.py

      - name: 上传分片结果
        if: always() && !cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: dl-result-${{ matrix.shard }}
          path: data/dl_results/shard_${{ matrix.shard }}.json
          retention-days: 3
          if-no-files-found: ignore

  report:
    if: always() && !cancelled() && needs.prepare.outputs.should_run == 'true'
    needs: [prepare, download]
    runs-on: ubuntu-latest
    steps:
      - name: 检出 stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: 下载所有分片结果
        uses: actions/download-artifact@v4
        with:
          pattern: dl-result-*
          path: data/dl_results
          merge-multiple: true

      - name: 汇总报告
        env:
          INPUT_DATE: ${{ inputs.date }}
          INPUT_CODES: ${{ inputs.codes }}
        run: python3 scripts/merge_dl_report.py
