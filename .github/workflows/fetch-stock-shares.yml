name: 更新股票股本结构
permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      stock_grabber_ref:
        description: 'stock-grabber 分支/标签/提交（需包含 scripts/fetch_stock_shares.py）'
        required: false
        default: 'main'
        type: string
      shard_count:
        description: '分片数量'
        required: false
        default: '40'
        type: string
      page_workers:
        description: '分页抓取并发数'
        required: false
        default: '12'
        type: string
      only_secids:
        description: '可选：仅处理指定股票，逗号分隔，只支持 6 位数字（如 600000,300682,920001）'
        required: false
        default: ''
        type: string

env:
  TZ: Asia/Shanghai

jobs:
  fetch-and-prepare:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.matrix.outputs.should_run }}
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: 检出 stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          ref: ${{ inputs.stock_grabber_ref }}
          token: ${{ secrets.GRABBER_PAT }}
          path: stock-grabber

      - name: 校验脚本存在
        run: |
          test -f stock-grabber/scripts/fetch_stock_shares.py || {
            echo "未找到 stock-grabber/scripts/fetch_stock_shares.py"
            echo "请确认 stock_grabber_ref=${{ inputs.stock_grabber_ref }} 对应分支已包含该脚本"
            exit 1
          }

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 抓取全部股本分页并生成索引
        env:
          MODE: fetch-all
          SHARES_PAGE_WORKERS: ${{ inputs.page_workers }}
          ONLY_SECIDS: ${{ inputs.only_secids }}
        working-directory: stock-grabber
        run: python3 scripts/fetch_stock_shares.py

      - name: 生成分片矩阵
        id: matrix
        env:
          MODE: prepare-matrix
          SHARD_COUNT: ${{ inputs.shard_count }}
          ONLY_SECIDS: ${{ inputs.only_secids }}
        working-directory: stock-grabber
        run: python3 scripts/fetch_stock_shares.py

      - name: 上传股本临时分页
        uses: actions/upload-artifact@v4
        with:
          name: stock-shares-pages
          path: stock-grabber/data/stock_shares_pages
          retention-days: 2

      - name: 上传股本索引
        uses: actions/upload-artifact@v4
        with:
          name: stock-shares-index
          path: |
            stock-grabber/data/stock_shares_index.json
            stock-grabber/data/stock_shares_summary.json
          retention-days: 2

  push-shard:
    if: needs.fetch-and-prepare.outputs.should_run == 'true'
    needs: fetch-and-prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 40
      matrix: ${{ fromJson(needs.fetch-and-prepare.outputs.matrix) }}
    steps:
      - name: 检出 stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          ref: ${{ inputs.stock_grabber_ref }}
          token: ${{ secrets.GRABBER_PAT }}
          path: stock-grabber

      - name: 校验脚本存在
        run: |
          test -f stock-grabber/scripts/fetch_stock_shares.py || {
            echo "未找到 stock-grabber/scripts/fetch_stock_shares.py"
            echo "请确认 stock_grabber_ref=${{ inputs.stock_grabber_ref }} 对应分支已包含该脚本"
            exit 1
          }

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 下载股本索引
        uses: actions/download-artifact@v4
        with:
          name: stock-shares-index
          path: .

      - name: 归位股本索引文件
        run: |
          mkdir -p stock-grabber/data

          if [ -f stock_shares_index.json ]; then
            mv stock_shares_index.json stock-grabber/data/stock_shares_index.json
          fi
          if [ -f stock_shares_summary.json ]; then
            mv stock_shares_summary.json stock-grabber/data/stock_shares_summary.json
          fi

          if [ -f data/stock_shares_index.json ]; then
            cp data/stock_shares_index.json stock-grabber/data/stock_shares_index.json
          fi
          if [ -f data/stock_shares_summary.json ]; then
            cp data/stock_shares_summary.json stock-grabber/data/stock_shares_summary.json
          fi

          if [ ! -f stock-grabber/data/stock_shares_index.json ]; then
            echo "未找到 stock_shares_index.json，当前文件结构:"
            find . -maxdepth 4 -type f | sort
            exit 1
          fi

      - name: 按分片推送股本数据 (分片 ${{ matrix.shard }})
        env:
          MODE: push-shard
          REPO_OWNER: ${{ secrets.TARGET_REPO_OWNER }}
          REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
          SECIDS: ${{ matrix.secids }}
          SHARD_ID: ${{ matrix.shard }}
        working-directory: stock-grabber
        run: python3 scripts/fetch_stock_shares.py
