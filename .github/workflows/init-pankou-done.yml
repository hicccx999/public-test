name: 初始化 pankou_done.json
permissions:
  contents: write

on:
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.matrix.outputs.should_run }}
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: 检出 stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: 生成分片矩阵
        id: matrix
        env:
          MODE: init-done
        run: python3 scripts/prepare_matrix.py

  init-shard:
    if: needs.prepare.outputs.should_run == 'true'
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 40
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: 检出 stock-grabber
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: 初始化 pankou_done (分片 ${{ matrix.shard }}, ${{ matrix.count }} 只)
        env:
          REPO_OWNER: ${{ secrets.TARGET_REPO_OWNER }}
          REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
          SECIDS: ${{ matrix.secids }}
          SHARD_ID: ${{ matrix.shard }}
        run: python3 scripts/init_pankou_done.py
