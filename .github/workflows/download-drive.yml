name: ä¸‹è½½å†å²æ•°æ®å¹¶ä¸Šä¼  Google Drive

on:
  workflow_dispatch:
    inputs:
      stocks:
        description: 'è‚¡ç¥¨åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼Œå¦‚: sz300682,sh600267ï¼‰'
        required: true
        type: string
      year:
        description: 'å¹´ä»½ï¼ˆå¦‚: 2025ï¼‰'
        required: true
        type: string

env:
  TZ: Asia/Shanghai

jobs:
  # ============================================================
  # ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆåˆ†ç‰‡çŸ©é˜µ (secid Ã— month)
  # ============================================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.gen.outputs.matrix }}
      year: ${{ steps.gen.outputs.year }}
      should_run: ${{ steps.gen.outputs.should_run }}
    steps:
      - name: æ£€å‡º stock-grabber ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: ç”Ÿæˆåˆ†ç‰‡çŸ©é˜µ
        id: gen
        run: |
          python3 scripts2/prepare-matrix-manual.py \
            stocks="${{ github.event.inputs.stocks }}" \
            year="${{ github.event.inputs.year }}"

  # ============================================================
  # ç¬¬äºŒæ­¥ï¼šå¹¶è¡Œä¸‹è½½ï¼ˆæ¯ä¸ª job = ä¸€åªè‚¡ç¥¨çš„ä¸€ä¸ªæœˆæ•°æ®ï¼‰
  # ============================================================
  download:
    needs: prepare
    if: needs.prepare.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: æ‰“å°ä»»åŠ¡ä¿¡æ¯
        run: |
          echo "ğŸ“ˆ è‚¡ç¥¨: ${{ matrix.secid }}"
          echo "ğŸ“… æœˆä»½: ${{ needs.prepare.outputs.year }}-${{ matrix.month }}"
          echo "ğŸ“… èŒƒå›´: ${{ matrix.from_date }} ~ ${{ matrix.to_date }}"

      - name: æ£€å‡º stock-grabber ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ä¸‹è½½æ•°æ®
        run: |
          python3 scripts2/fetch-upload-drive.py \
            secid=${{ matrix.secid }} \
            from=${{ matrix.from_date }} \
            to=${{ matrix.to_date }} \
            output_dir=./output

      - name: ä¸Šä¼  artifact
        uses: actions/upload-artifact@v4
        with:
          name: data-${{ matrix.secid }}-${{ matrix.month }}
          path: output/${{ matrix.secid }}/
          retention-days: 1

  # ============================================================
  # ç¬¬ä¸‰æ­¥ï¼šæ±‡æ€»æ‰“åŒ…å¹¶ä¸Šä¼  Google Drive
  # ============================================================
  upload:
    needs: [prepare, download]
    if: needs.prepare.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡º stock-grabber ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: å®‰è£…ä¾èµ–
        run: pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib

      - name: ä¸‹è½½æ‰€æœ‰ artifact
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: data-*

      - name: æ•´ç†ç›®å½•ç»“æ„å¹¶æ‰“åŒ…ä¸Šä¼ 
        env:
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
          UPLOAD_DRIVE: 'true'
        run: |
          YEAR="${{ needs.prepare.outputs.year }}"
          STOCKS="${{ github.event.inputs.stocks }}"

          echo "ğŸ“ æ•´ç† artifact ç›®å½•..."
          ls -la ./artifacts/

          # å°† artifacts/data-{secid}-{month}/{year}/{month}/ åˆå¹¶åˆ° output/{secid}/{year}/{month}/
          mkdir -p ./output
          for dir in ./artifacts/data-*/; do
            # ä»ç›®å½•åæå– secid: data-sz300682-01 â†’ sz300682
            dirname=$(basename "$dir")
            secid=$(echo "$dirname" | sed 's/^data-//' | sed 's/-[0-9]*$//')
            
            echo "  ğŸ“‚ åˆå¹¶: $dirname â†’ output/$secid/"
            mkdir -p "./output/$secid"
            cp -r "$dir"* "./output/$secid/" 2>/dev/null || true
          done

          echo ""
          echo "ğŸ“ åˆå¹¶åç›®å½•ç»“æ„:"
          find ./output -type f | head -20
          echo "..."

          # æŒ‰è‚¡ç¥¨é€ä¸ªæ‰“åŒ…å¹¶ä¸Šä¼ 
          IFS=',' read -ra STOCK_LIST <<< "$STOCKS"
          for SECID in "${STOCK_LIST[@]}"; do
            SECID=$(echo "$SECID" | xargs)
            echo ""
            echo "============================================"
            echo "ğŸ“¦ æ‰“åŒ…å¹¶ä¸Šä¼ : $SECID ($YEAR)"
            echo "============================================"
            
            python3 scripts2/fetch-upload-drive.py \
              secid="$SECID" \
              from="${YEAR}0101" \
              to="${YEAR}1231" \
              output_dir=./output
          done

          echo ""
          echo "ğŸ‰ å…¨éƒ¨å®Œæˆï¼"
