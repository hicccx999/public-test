name: ä¸‹è½½å†å²æ•°æ®å¹¶ä¸Šä¼  Google Drive

on:
#   schedule:
#     # æ¯å°æ—¶æ•´ç‚¹æ‰§è¡Œï¼ŒUTC 0-21 ç‚¹ = 22 ä¸ª batchï¼Œ22 å°æ—¶å®Œæˆå…¨é‡
#     - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      stocks:
        description: 'è‚¡ç¥¨åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼Œå¦‚ sz300682,sh600267ï¼‰ã€‚ç•™ç©ºåˆ™è‡ªåŠ¨æŒ‰ batch åˆ†é¡µå¤„ç†å…¨å¸‚åœº'
        required: false
        type: string
      year:
        description: 'å¹´ä»½ï¼ˆé»˜è®¤ 2025ï¼‰'
        required: false
        type: string
        default: '2025'
      batch_number:
        description: 'å…¨é‡æ¨¡å¼çš„æ‰¹æ¬¡å·ï¼ˆ0-21ï¼‰ã€‚ç•™ç©ºåˆ™è‡ªåŠ¨æŒ‰ UTC å°æ—¶è®¡ç®—'
        required: false
        type: string
      batch_size:
        description: 'æ¯æ‰¹è‚¡ç¥¨æ•°é‡ï¼ˆé»˜è®¤ 256ï¼Œä¸Šé™ 256ï¼‰'
        required: false
        type: string
        default: '256'

env:
  TZ: Asia/Shanghai

jobs:
  # ============================================================
  # ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆåˆ†ç‰‡çŸ©é˜µ
  # ============================================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.gen.outputs.matrix }}
      year: ${{ steps.gen.outputs.year }}
      mode: ${{ steps.gen.outputs.mode }}
      should_run: ${{ steps.gen.outputs.should_run }}
    steps:
      - name: æ£€å‡º stock-grabber ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: ç”Ÿæˆåˆ†ç‰‡çŸ©é˜µ
        id: gen
        run: |
          ARGS="year=${{ github.event.inputs.year || '2025' }}"

          if [ -n "${{ github.event.inputs.stocks }}" ]; then
            ARGS="$ARGS stocks=${{ github.event.inputs.stocks }}"
          fi

          if [ -n "${{ github.event.inputs.batch_number }}" ]; then
            ARGS="$ARGS batch_number=${{ github.event.inputs.batch_number }}"
          fi

          if [ -n "${{ github.event.inputs.batch_size }}" ]; then
            ARGS="$ARGS batch_size=${{ github.event.inputs.batch_size }}"
          fi

          echo "å‚æ•°: $ARGS"
          python3 scripts2/prepare-matrix-manual.py $ARGS

  # ============================================================
  # ç¬¬äºŒæ­¥ï¼šå¹¶è¡Œä¸‹è½½ + æ‰“åŒ… + ä¸Šä¼  Google Drive
  # ============================================================
  download:
    needs: prepare
    if: needs.prepare.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: æ‰“å°ä»»åŠ¡ä¿¡æ¯
        run: |
          echo "ğŸ“ˆ è‚¡ç¥¨: ${{ matrix.secid }}"
          echo "ğŸ“… èŒƒå›´: ${{ matrix.from_date }} ~ ${{ matrix.to_date }}"
          echo "ğŸ“… å¹´ä»½: ${{ needs.prepare.outputs.year }}"
          echo "ğŸ”§ æ¨¡å¼: ${{ needs.prepare.outputs.mode }}"

      - name: æ£€å‡º stock-grabber ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: hiyishui/stock-grabber
          token: ${{ secrets.GRABBER_PAT }}

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: å®‰è£…ä¾èµ–
        run: pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib

      - name: ä¸‹è½½æ•°æ® + æ‰“åŒ… + ä¸Šä¼ 
        env:
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
          UPLOAD_DRIVE: 'true'
        run: |
          python3 scripts2/fetch-upload-drive.py \
            secid=${{ matrix.secid }} \
            from=${{ matrix.from_date }} \
            to=${{ matrix.to_date }}
